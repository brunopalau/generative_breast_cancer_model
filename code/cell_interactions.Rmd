---
title: "imcRtools analysis of the Pancreas dataset"
author: "Bruno Palau"
date: "`r Sys.Date()`"
output: html_document
---

#Quantify Interactions between celltypes in breast cancer tissue to use it in generative model

##import libraries and breast cancer single cell experiment
```{r}

library(imcdatasets)
library(imcRtools)

sce <- JacksonFischer2020Data(data_type = "sce")
```

##subset and build spatial graph
```{r}
subset <- sce[,sce$ImageNb == 29]
#use 8 neighbors to simulate nearest 8 neighbors on grid
subset <- buildSpatialGraph(subset, img_id = "ImageNb",
                            coords=c("Location_Center_X", "Location_Center_Y"),     
                            type = "knn",
                            k = 8)
subset$metacluster <- as.factor(subset$metacluster)
plotSpatial(subset,
            img_id = "ImageNb",
            coords=c("Location_Center_X", "Location_Center_Y"),
            node_color_by = "metacluster",
            draw_edges = TRUE,
            colPairName = "knn_interaction_graph",
            directed = FALSE,
            nodes_first = FALSE)
```
#compute interactions between metaclusters
```{r}

interactions <- testInteractions(subset,
                        group_by = "ImageNb",
                        label = "metacluster",
                        method = "classic",
                        colPairName = "knn_interaction_graph")

subset <- interactions[,c("group_by","from_label","to_label","ct")]
interactions_image <- split(subset[,c("from_label","to_label","ct")],subset$group_by)

interaction_matrix <- lapply(interactions_image,function(x){
  as.matrix(subset(reshape(x, idvar="from_label",timevar = "to_label", direction = "wide"),select=-c(1)))
})
```

## do same analysis for all images
```{r}
sce <- buildSpatialGraph(sce, img_id = "ImageNb",
                            coords=c("Location_Center_X", "Location_Center_Y"),     
                            type = "knn",
                            k = 8)
sce$metacluster <- as.factor(sce$metacluster)
plotSpatial(sce,
            img_id = "ImageNb",
            coords=c("Location_Center_X", "Location_Center_Y"),
            node_color_by = "metacluster",
            draw_edges = TRUE,
            colPairName = "knn_interaction_graph",
            directed = FALSE,
            nodes_first = FALSE)
out <- testInteractions(sce,
                        group_by = "ImageNb",
                        label = "metacluster",
                        method = "classic",
                        colPairName = "knn_interaction_graph")

sub_out <- out[,c("group_by","from_label","to_label","ct")]
out_image <- split(sub_out[,c("from_label","to_label","ct")],sub_out$group_by)

sigval_matrix <- lapply(out_image,function(x){
  as.matrix(subset(reshape(x, idvar="from_label",timevar = "to_label", direction = "wide"),select=-c(1)))
})
```
