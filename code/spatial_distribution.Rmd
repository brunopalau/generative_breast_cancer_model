---
title: "spatial_distribution"
author: "BrunoPalau"
date: "`r Sys.Date()`"
output: html_document
---
#Analyse the spatial distribution of cells in breast cancer tissue

##import libraries and breast cancer single cell experiment
```{r,include=FALSE}
library(MASS)
library(ComplexHeatmap)
library(imcdatasets)
library(imcRtools)
library(Giotto)

library(dplyr)
library(viridis)

library(scales)
library(ggplot2)
library(cowplot)

sce <- JacksonFischer2020Data(data_type = "sce")
```

##subset and build spatial graph
```{r}

subset <- sce[,sce$ImageNb == 29]

#use 8 neighbors to simulate nearest 8 neighbors on grid
subset <- buildSpatialGraph(subset, img_id = "ImageNb",
                            coords=c("Location_Center_X", "Location_Center_Y"),     
                            type = "knn",
                            k = 8)
subset$metacluster <- as.factor(subset$metacluster)

# take subset for visualization
plotSpatial(subset,
            img_id = "ImageNb",
            coords=c("Location_Center_X", "Location_Center_Y"),
            node_color_by = "metacluster",
            draw_edges = TRUE,
            colPairName = "knn_interaction_graph",
            directed = FALSE,
            nodes_first = FALSE)
```


```{r}
img_nr_list <- list(29,30,31)
spatial_df_list <- list()
for (img_nr in img_nr_list){
  subset <- subset <- sce[,sce$ImageNb == img_nr]

  spatial_df <- data.frame(x = subset$Location_Center_X, y = subset$Location_Center_Y, metacluster = subset$metacluster)
  
  spatial_df_list <- append(spatial_df_list,list(spatial_df))
}
```


```{r, fig.width = 20,fig.height=20}
# spatial distribution seems to be binomial in the sense that it is either empty or 
list_total_plot <- list()
list_meta_plot <- list()

for (spatial_df in spatial_df_list){
  total_plot <- ggplot(spatial_df,aes(x=x,y=y))+
    geom_bin2d(bins=50)+
    scale_fill_continuous(type="viridis")+
    theme_bw()
  
  meta_plot <- ggplot(spatial_df,aes(x=x,y=y))+
    geom_bin2d(bins=50)+
    scale_fill_continuous(type="viridis")+
    facet_wrap(~metacluster)+
    theme_bw()
  
  list_total_plot <- append(list_total_plot,list(total_plot))
  list_meta_plot <- append(list_meta_plot,list(meta_plot))
}

plot_grid(plotlist = list_total_plot)
plot_grid(plotlist = list_meta_plot)

# specially cluster 25 and 18 seems to have some kind of spatial distributions

# todo: get bins calculated and make histogram of that for multiple images in dataset
# todo: make a colored version of this to see if one metacluster is overrepresented in 
```
